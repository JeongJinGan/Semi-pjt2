{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load django_bootstrap5 %}
{% block title %}{% endblock title %}

{% block content %}
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div class='container'>
  <div class="d-flex">
  <div id="map" style="width:350px;height:350px;"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c262112c4811d99bb369cd08f0c8ef80&libraries=clusterer&libraries=services"></script>
<script>
var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
    mapOption = { 
        center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
        level: 3 // 지도의 확대 레벨
    };

// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
var map = new kakao.maps.Map(mapContainer, mapOption); 
</script>

<div style="font-size: 2em;">
  <dl class="row m-3">
    <dt class="col-4 text-center">Title</dt>
    <dd class="col-8">{{ post.title }}</dd>
    <dt class="col-4 text-center">Day</dt>
    <dd class="col-8">{{ post.day }}</dd>
    <dt class="col-4 text-center">Time</dt>
    <dd class="col-8">{{post.time}}</dd>
    <dt class="col-4 text-center">애완동물 유/무</dt>
    <dd class="col-8">{{post.pet}}</dd> 
    <dt class="col-4 text-center">내용</dt>
    <dd class="col-8">{{ post.content }}</dd>
    <dt class="col-4 text-center">생성일</dt>
    <dd class="col-8">{{ post.created_at|date:'Y-m-d' }}</dd>
  </dl>
</div>


</div>


<h1>comment</h1>
<form action="{% url 'articles:comment' post.pk %}" method="POST" id="comment-form" data-post-id="{{ post.pk }}">
  {% csrf_token %}
  {% bootstrap_form comment_form %}
  <input class="btn pos-btn" type="submit" value="Submit">
</form>


<div class="comments">
  {% for comment in comments %}
  <div class="comment">
    <img class="comment-profile-img" src="{{ comment.user.profile_pic.url }}" alt="{{ comment.user.profile_pic }}">
    <div class="comment-detail">
      <p class="comment-profile-name"><a class="comment-profile-name" href="#">{{ comment.user.nickname }}</a></p>
      <p class="comment-content">{{ comment.content }}</p>
    </div>
  </div>
  {% endfor %}

{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const commentForm = document.querySelector("#comment-form")
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  commentForm.addEventListener("submit", function(event) {
    event.preventDefault();
    axios({
      method: 'post',
      url: `/articles/${event.target.dataset.postId}/comment/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(commentForm)
    })
      .then(response => {
        const comments = document.querySelector(".comments")
        comments.textContent = "",
        const commentData = response.data.commentData
        const user = response.data.user

        for (let i = 0; i < commentData.length; i++) {
          const postId = response.data.reviewPK

          if (user === commentData[i].id) {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <img class="comment-profile-img" src="${commentData[i].profile_img}" alt="유저 이미지">
              <div class="comment-detail">
                <p class="comment-profile-name">사용 중<a class="comment-profile-name" href="#">${commentData[i].profile_name}</a></p>
                <p class="comment-content">${commentData[i].content}</p>
              </div>
            </div>
            `)
          } else {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <img class="comment-profile-img" src="${commentData[i].profile_img}" alt="유저 이미지">
              <div class="comment-detail">
                <p class="comment-profile-name"><a class="comment-profile-name" href="#">${commentData[i].profile_name}</a></p>
                <p class="comment-content">${commentData[i].content}</p>
              </div>
            </div>
            `)
          }
      }
      commentForm.reset()
    })
  })
</script>

{% endblock script %}